<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>data.provider.nova_iterator &mdash; NOVA-Utils 1.1.0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            NOVA-Utils
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/nova_utils.scripts.html">nova_utils.scripts package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/nova_utils.data.html">nova_utils.data package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/nova_utils.interfaces.html">nova_utils.interfaces package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/nova_utils.utils.html">nova_utils.utils package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">NOVA-Utils</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">data.provider.nova_iterator</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for data.provider.nova_iterator</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; Module to create a data iterator for streams and annotations</span>

<span class="sd">Author:</span>
<span class="sd">    Dominik Schiller &lt;dominik.schiller@uni-a.de&gt;</span>
<span class="sd">Date:</span>
<span class="sd">    18.8.2023</span>
<span class="sd">    </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">nova_utils.data.data</span> <span class="kn">import</span> <span class="n">Data</span>
<span class="kn">from</span> <span class="nn">nova_utils.data.stream</span> <span class="kn">import</span> <span class="n">Stream</span><span class="p">,</span> <span class="n">StreamMetaData</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">nova_utils.data.handler.mongo_handler</span> <span class="kn">import</span> <span class="n">AnnotationHandler</span><span class="p">,</span> <span class="n">StreamHandler</span><span class="p">,</span> <span class="n">SessionHandler</span>
<span class="kn">from</span> <span class="nn">nova_utils.data.handler.file_handler</span> <span class="kn">import</span> <span class="n">FileHandler</span>
<span class="kn">from</span> <span class="nn">nova_utils.utils</span> <span class="kn">import</span> <span class="n">string_utils</span>
<span class="kn">from</span> <span class="nn">nova_utils.utils.anno_utils</span> <span class="kn">import</span> <span class="n">data_contains_garbage</span>
<span class="kn">from</span> <span class="nn">nova_utils.data.session</span> <span class="kn">import</span> <span class="n">Session</span>


<div class="viewcode-block" id="NovaIterator"><a class="viewcode-back" href="../../../api/data.provider.html#data.provider.nova_iterator.NovaIterator">[docs]</a><span class="k">class</span> <span class="nc">NovaIterator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iterator class for processing data samples from the Nova dataset.</span>

<span class="sd">    The NovaIterator takes all information about what data should be loaded and how it should be processed. The class itself then takes care of loading all data and provides an iterator to directly apply a sliding window to the requested data.</span>
<span class="sd">    Every time based argument can be passed either as string or a numerical value. If the time is passed as string, the string should end with either &#39;s&#39; to indicate the time is specified in seconds or &#39;ms&#39; for milliseconds.</span>
<span class="sd">    If the time is passed as a numerical value or as a string without indicating a specific unit it is assumed that an integer value represents milliseconds while a float represents seconds. All numbers will be represented as integer milliseconds internally.</span>
<span class="sd">    The highest time resolution for processing is therefore 1ms.</span>

<span class="sd">    Args:</span>
<span class="sd">        db_host (str): Database IP address.</span>
<span class="sd">        db_port (int): Database port.</span>
<span class="sd">        db_user (str): Database username.</span>
<span class="sd">        db_password (str): Database password.</span>
<span class="sd">        dataset (str): Name of the dataset.</span>
<span class="sd">        data_dir (Path, optional): Path to the data directory. Defaults to None.</span>
<span class="sd">        sessions (list[str], optional): List of session names to process. Defaults to None.</span>
<span class="sd">        data (list[dict], optional): List of data descriptions. Defaults to None.</span>
<span class="sd">        frame_size (Union[int, float, str], optional): Size of the data frame measured in time. Defaults to None.</span>
<span class="sd">        start (Union[int, float, str], optional): Start time for processing measured in time. Defaults to None.</span>
<span class="sd">        end (Union[int, float, str], optional): End time for processing measured in time. Defaults to None.</span>
<span class="sd">        left_context (Union[int, float, str], optional): Left context duration measured in time. Defaults to None.</span>
<span class="sd">        right_context (Union[int, float, str], optional): Right context duration measured in time. Defaults to None.</span>
<span class="sd">        stride (Union[int, float, str], optional): Stride for iterating over data measured in time. If stride is not set explicitly it will be set to frame_size. Defaults to None.</span>
<span class="sd">        add_rest_class (bool, optional): Whether to add a rest class for discrete annotations. Defaults to True.</span>
<span class="sd">        fill_missing_data (bool, optional): Whether to fill missing data. Defaults to True. THIS OPTION IS CURRENTLY NOT DOING ANYTHING</span>

<span class="sd">    Attributes:</span>
<span class="sd">        data_dir (Path): Path to the data directory.</span>
<span class="sd">        dataset (str): Name of the dataset.</span>
<span class="sd">        sessions (list[str]): List of session names to process.</span>
<span class="sd">        data (list[dict]): List of data descriptions.</span>
<span class="sd">        ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="c1"># Database connection</span>
            <span class="n">db_host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">db_port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">db_user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">db_password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">dataset</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">data_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

            <span class="c1"># Data</span>
            <span class="n">sessions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

            <span class="c1"># Iterator Window</span>
            <span class="n">frame_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span> <span class="p">,</span> <span class="nb">float</span> <span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span> <span class="p">,</span> <span class="nb">float</span> <span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span> <span class="p">,</span> <span class="nb">float</span> <span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">left_context</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span> <span class="p">,</span> <span class="nb">float</span> <span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">right_context</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span> <span class="p">,</span> <span class="nb">float</span> <span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">stride</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span> <span class="p">,</span> <span class="nb">float</span> <span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>

            <span class="c1"># Iterator properties</span>
            <span class="n">add_rest_class</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">fill_missing_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="p">):</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span> <span class="o">=</span> <span class="n">sessions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>


        <span class="c1"># If stride has not been explicitly set it&#39;s the same as the frame size</span>
        <span class="k">if</span> <span class="n">stride</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">frame_size</span>

        <span class="c1"># Parse all times to milliseconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left_context</span> <span class="o">=</span> <span class="n">string_utils</span><span class="o">.</span><span class="n">parse_time_string_to_ms</span><span class="p">(</span><span class="n">left_context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right_context</span> <span class="o">=</span> <span class="n">string_utils</span><span class="o">.</span><span class="n">parse_time_string_to_ms</span><span class="p">(</span><span class="n">right_context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_size</span> <span class="o">=</span> <span class="n">string_utils</span><span class="o">.</span><span class="n">parse_time_string_to_ms</span><span class="p">(</span><span class="n">frame_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">string_utils</span><span class="o">.</span><span class="n">parse_time_string_to_ms</span><span class="p">(</span><span class="n">stride</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">string_utils</span><span class="o">.</span><span class="n">parse_time_string_to_ms</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">string_utils</span><span class="o">.</span><span class="n">parse_time_string_to_ms</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>


        <span class="c1"># Frame size 0 or None indicates that the whole session should be returned as one sample</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Frame size should be bigger than zero. Returning whole session as sample.&quot;</span><span class="p">)</span>

        <span class="c1"># If the end time has not been set we initialize it with sys.maxsize</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">add_rest_class</span> <span class="o">=</span> <span class="n">add_rest_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_missing_data</span> <span class="o">=</span> <span class="n">fill_missing_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_session</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Data handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_session_handler</span> <span class="o">=</span> <span class="n">SessionHandler</span><span class="p">(</span><span class="n">db_host</span><span class="p">,</span> <span class="n">db_port</span><span class="p">,</span> <span class="n">db_user</span><span class="p">,</span> <span class="n">db_password</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_anno_handler</span> <span class="o">=</span> <span class="n">AnnotationHandler</span><span class="p">(</span><span class="n">db_host</span><span class="p">,</span> <span class="n">db_port</span><span class="p">,</span> <span class="n">db_user</span><span class="p">,</span> <span class="n">db_password</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_stream_handler</span> <span class="o">=</span> <span class="n">StreamHandler</span><span class="p">(</span><span class="n">db_host</span><span class="p">,</span> <span class="n">db_port</span><span class="p">,</span> <span class="n">db_user</span><span class="p">,</span> <span class="n">db_password</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_handler</span> <span class="o">=</span> <span class="n">FileHandler</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_iterable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yield_sample</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">_init_data_from_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_desc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Data</span><span class="p">:</span>
        <span class="n">src</span><span class="p">,</span> <span class="n">type_</span> <span class="o">=</span> <span class="n">data_desc</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="s1">&#39;db&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="s1">&#39;anno&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_anno_handler</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span><span class="n">scheme</span><span class="o">=</span><span class="n">data_desc</span><span class="p">[</span><span class="s1">&#39;scheme&#39;</span><span class="p">],</span><span class="n">annotator</span><span class="o">=</span><span class="n">data_desc</span><span class="p">[</span><span class="s1">&#39;annotator&#39;</span><span class="p">],</span><span class="n">role</span><span class="o">=</span><span class="n">data_desc</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="s1">&#39;stream&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_stream_handler</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">data_desc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">role</span><span class="o">=</span><span class="n">data_desc</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown data type </span><span class="si">{</span><span class="n">type_</span><span class="si">}</span><span class="s1"> for data.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">src</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_handler</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">data_desc</span><span class="p">[</span><span class="s1">&#39;fp&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown source type </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1"> for data.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_data_description_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_desc</span><span class="p">:</span><span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">src</span><span class="p">,</span> <span class="n">type_</span> <span class="o">=</span> <span class="n">data_desc</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">delim</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span>
        <span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="s1">&#39;db&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="s1">&#39;anno&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">delim</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">data_desc</span><span class="p">[</span><span class="s1">&#39;scheme&#39;</span><span class="p">],</span> <span class="n">data_desc</span><span class="p">[</span><span class="s1">&#39;annotator&#39;</span><span class="p">],</span><span class="n">data_desc</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]])</span>
            <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="s1">&#39;stream&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">delim</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">data_desc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">data_desc</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown data type </span><span class="si">{</span><span class="n">type_</span><span class="si">}</span><span class="s1"> for data.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">src</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">delim</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">data_desc</span><span class="p">[</span><span class="s1">&#39;fp&#39;</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown source type </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1"> for data.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Session</span><span class="p">:</span>

        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_session_handler</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">session_name</span><span class="p">)</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Opens all annotations and data readers&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># setting session data</span>
        <span class="k">for</span> <span class="n">data_desc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">data_initialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_data_from_description</span><span class="p">(</span><span class="n">data_desc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">session_name</span><span class="p">)</span>
            <span class="n">data_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_description_to_string</span><span class="p">(</span><span class="n">data_desc</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">data_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_initialized</span>
        <span class="n">session</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="c1"># update session duration</span>
        <span class="n">min_dur</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">duration</span> <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span>
        <span class="k">for</span> <span class="n">data_initialized</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_initialized</span><span class="p">,</span> <span class="n">Stream</span><span class="p">):</span>
                <span class="n">meta_data</span> <span class="p">:</span> <span class="n">StreamMetaData</span> <span class="o">=</span> <span class="n">data_initialized</span><span class="o">.</span><span class="n">meta_data</span>
                <span class="k">if</span> <span class="n">meta_data</span><span class="o">.</span><span class="n">duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dur</span> <span class="o">=</span> <span class="n">meta_data</span><span class="o">.</span><span class="n">duration</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dur</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_initialized</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="n">meta_data</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="k">if</span> <span class="n">dur</span> <span class="o">&lt;</span> <span class="n">min_dur</span><span class="p">:</span>
                    <span class="n">min_dur</span> <span class="o">=</span> <span class="n">dur</span>
        <span class="n">session</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">min_dur</span>

        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">duration</span> <span class="o">==</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unable to determine duration for session </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">session</span>


    <span class="k">def</span> <span class="nf">_yield_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Yields examples.&quot;&quot;&quot;</span>

        <span class="c1"># Needed to sort the samples later and assure that the order is the same as in nova.</span>
        <span class="n">sample_counter</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>

            <span class="c1"># Init all data objects for the session and get necessary meta information</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

            <span class="c1">#If frame size is zero or less we return the whole data from the whole session in one sample</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
               <span class="n">_frame_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_session</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
               <span class="n">_stride</span> <span class="o">=</span> <span class="n">_frame_size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_frame_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_size</span>
                <span class="n">_stride</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span>

            <span class="c1"># Starting position of the first frame in seconds</span>
            <span class="n">cpos</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left_context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>

            <span class="c1"># TODO account for stride and framesize being None</span>
            <span class="c1"># Generate samples for this session</span>
            <span class="k">while</span> <span class="n">cpos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_context</span> <span class="o">&lt;=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session</span><span class="o">.</span><span class="n">duration</span>
            <span class="p">):</span>

                <span class="n">frame_start</span> <span class="o">=</span> <span class="n">cpos</span>
                <span class="n">frame_end</span> <span class="o">=</span> <span class="n">cpos</span> <span class="o">+</span> <span class="n">_frame_size</span>
                <span class="n">window_start</span> <span class="o">=</span> <span class="n">frame_start</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_context</span>
                <span class="n">window_end</span> <span class="o">=</span> <span class="n">frame_end</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_context</span>


                <span class="n">window_info</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">session</span>
                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">window_start</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">window_end</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># Load data for frame</span>
                <span class="n">data_for_window</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span> <span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">sample_from_interval</span><span class="p">(</span><span class="n">window_start</span><span class="p">,</span> <span class="n">window_end</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>

                <span class="c1"># Performing sanity checks</span>
                <span class="n">garbage_detected</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span> <span class="n">data_contains_garbage</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data_for_window</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>  <span class="p">])</span>

                <span class="c1"># Incrementing counter</span>
                <span class="n">cpos</span> <span class="o">+=</span> <span class="n">_stride</span>
                <span class="n">sample_counter</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">garbage_detected</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">yield</span> <span class="n">data_for_window</span>


    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterable</span>

    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterable</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span></div>

    <span class="c1"># def get_output_info(self):</span>
    <span class="c1">#     def map_label_id(lid):</span>
    <span class="c1">#         if self.flatten_samples and not lid == &quot;frame&quot;:</span>
    <span class="c1">#             return split_role_key(lid)[-1]</span>
    <span class="c1">#         return lid</span>
    <span class="c1">#</span>
    <span class="c1">#     return {</span>
    <span class="c1">#         # Adding fake framenumber label for sorting</span>
    <span class="c1">#         &quot;frame&quot;: {&quot;dtype&quot;: np.str, &quot;shape&quot;: (1,)},</span>
    <span class="c1">#         **{map_label_id(k): v.get_info()[1] for k, v in self.annos.items()},</span>
    <span class="c1">#         **{map_label_id(k): v.get_info()[1] for k, v in self.data_info.items()},</span>
    <span class="c1"># }</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

    <span class="n">load_dotenv</span><span class="p">(</span><span class="s2">&quot;../../../.env&quot;</span><span class="p">)</span>
    <span class="n">IP</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NOVA_IP&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">PORT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NOVA_PORT&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">USER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NOVA_USER&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">PASSWORD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NOVA_PASSWORD&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NOVA_DATA_DIR&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span>
    <span class="n">sessions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;04_Oesterreich_test&#39;</span><span class="p">]</span>

    <span class="n">annotation</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="s1">&#39;db:anno&#39;</span><span class="p">,</span>
        <span class="s1">&#39;scheme&#39;</span><span class="p">:</span> <span class="s1">&#39;transcript&#39;</span><span class="p">,</span>
        <span class="s1">&#39;annotator&#39;</span><span class="p">:</span> <span class="s1">&#39;whisperx&#39;</span><span class="p">,</span>
        <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;testrole&#39;</span>
    <span class="p">}</span>

    <span class="n">stream</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="s1">&#39;db:stream&#39;</span><span class="p">,</span>
        <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;testrole&#39;</span><span class="p">,</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;arousal.synchrony[testrole2]&#39;</span>
    <span class="p">}</span>

    <span class="n">file</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;src&#39;</span> <span class="p">:</span> <span class="s1">&#39;file:stream&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fp&#39;</span><span class="p">:</span> <span class="s1">&#39;/Users/dominikschiller/Work/github/nova-utils/test_files/new_test_video.mp4&#39;</span>
    <span class="p">}</span>

    <span class="n">nova_iterator</span> <span class="o">=</span> <span class="n">NovaIterator</span><span class="p">(</span>
        <span class="n">IP</span><span class="p">,</span>
        <span class="n">PORT</span><span class="p">,</span>
        <span class="n">USER</span><span class="p">,</span>
        <span class="n">PASSWORD</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">,</span>
        <span class="n">DATA_DIR</span><span class="p">,</span>
        <span class="n">sessions</span><span class="o">=</span><span class="n">sessions</span><span class="p">,</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">annotation</span><span class="p">,</span> <span class="n">file</span><span class="p">],</span>
        <span class="n">frame_size</span><span class="o">=</span><span class="s1">&#39;5s&#39;</span><span class="p">,</span>
        <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;20s&#39;</span>
    <span class="p">)</span>

    <span class="n">a</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">nova_iterator</span><span class="p">)</span>
    <span class="nb">breakpoint</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Dominik Schiller.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>